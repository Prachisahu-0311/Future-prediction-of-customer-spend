# -*- coding: utf-8 -*-
"""Hackathon_deploy.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/13SWOP55JX2iGYyW-Y9xjrHg7eQVHW1BN
"""

import streamlit as st
import pandas as pd
import numpy as np
import joblib
import matplotlib.pyplot as plt

# ----------------------------
# LOAD SAVED ARTIFACTS
# ----------------------------
clf = joblib.load("purchase_model.pkl")
reg = joblib.load("spend_model.pkl")
features = joblib.load("features.pkl")
actuals = joblib.load("actuals.pkl")

FEATURE_COLS = [c for c in features.columns if c != "customer_id"]

# ----------------------------
# STREAMLIT CONFIG
# ----------------------------
st.set_page_config(
    page_title="30-Day Customer Spend Prediction",
    layout="centered"
)

st.title("üìä Customer 30-Day Spend Prediction")
st.write(
    "This app predicts the **expected customer spend in the next 30 days** "
    "using historical purchase behavior (two-stage ML model)."
)

# ----------------------------
# CUSTOMER SELECTION
# ----------------------------
customer_id = st.selectbox(
    "Select Customer ID",
    sorted(features["customer_id"].unique())
)

# ----------------------------
# PREPARE INPUT
# ----------------------------
row = features[features["customer_id"] == customer_id]
X_row = row[FEATURE_COLS].values

# ----------------------------
# STAGE 1: PURCHASE PROBABILITY
# ----------------------------
purchase_prob = clf.predict_proba(X_row)[0, 1]

# ----------------------------
# STAGE 2: SPEND PREDICTION
# ----------------------------
spend_if_purchase = np.expm1(reg.predict(X_row))[0]
spend_if_purchase = max(0, spend_if_purchase)

predicted_spend = purchase_prob * spend_if_purchase

# ----------------------------
# ACTUAL SPEND (IF AVAILABLE)
# ----------------------------
actual_row = actuals[actuals["customer_id"] == customer_id]

actual_spend = (
    actual_row["future_spend_30d"].values[0]
    if not actual_row.empty
    else 0.0
)

# ----------------------------
# DISPLAY METRICS
# ----------------------------
col1, col2, col3 = st.columns(3)

col1.metric("Purchase Probability", f"{purchase_prob:.2f}")
col2.metric("Predicted Spend (¬£)", f"{predicted_spend:.2f}")
col3.metric("Actual Spend (¬£)", f"{actual_spend:.2f}")

# ----------------------------
# BAR CHART
# ----------------------------
fig, ax = plt.subplots()
ax.bar(["Actual", "Predicted"], [actual_spend, predicted_spend])
ax.set_ylabel("GBP (¬£)")
ax.set_title(f"Customer {customer_id}: 30-Day Spend")

st.pyplot(fig)

# ----------------------------
# EXPLANATION
# ----------------------------
st.markdown("""
### üîç How this works
- **Stage 1** predicts whether a customer will purchase
- **Stage 2** predicts how much they will spend if they purchase
- Final prediction = **probability √ó spend**

This approach handles customers who may not buy at all and avoids over-prediction.
""")